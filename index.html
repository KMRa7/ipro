<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>予約フォーム</title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    /* 右端の細いナビ（固定） */
    .side-nav {
      position: fixed;
      right: -5px;
      top: 80%;
      transform: translateY(-50%) translateX(20px);
      background: #13ca5e;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px;
      border-radius: 10px 0 0 10px;
      z-index: 1000;
      width: 35px;
    }
    .side-nav a:active { transform: scale(1.0); }
    .side-nav a {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: white; text-decoration: none; font-size: 10px; margin: 5px 0; padding: 5px;
      transition: background 0.3s, transform 0.2s; border-radius: 5px; width: 30px; height: 30px; text-align: center;
    }
    .side-nav a span { font-size: 24px; position: absolute; left: 0; top: 13px; }

    @media (max-width: 600px) {
      .side-nav { right: 2px; width: 30px; }
      .side-nav a { width: 28px; height: 28px; }
      .side-nav a i { font-size: 12px; }
    }

    body{
      font-family: 'Poppins', sans-serif; background-color: #e7e7e7;
      display: flex; justify-content: center; align-items: flex-start; height: 100vh;
      margin: 0; padding-top: 5px; overflow-x: hidden;
    }
    .container{
      background-color: #fdfdfd; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      width: 90%; max-width: 500px; padding: 25px; box-sizing: border-box; margin: 0 auto;
    }
    h1{
      background: linear-gradient(135deg, #13ca5e, #0fa958); color: white; padding: 20px;
      border-radius: 0 15px 0 45px; text-align: center; display: block; margin: -20px -15px 20px -15px;
      font-size: 26px; font-weight: 600; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.05);
      position: relative; overflow: hidden;
    }
    .label, .labelContent{
      display: block; margin-bottom: 10px; padding: 3px; font-weight: 600; background-color: #13ca5e;
      color: white; border-radius: 6px; font-size: 18px; text-align: center; position: relative; overflow: hidden;
    }
    .label{ text-indent: 20px; }
    .labelContent{ text-indent: 0; }

    .required{
      color: #ffffff; font-weight: lighter; font-size: 0.6em; margin-left: 5px; vertical-align: 0.8em;
      background-color: rgb(255, 15, 15); padding: 0 5px; border-radius: 3px; margin-right: 5px;
    }

    input[type="text"], input[type="tel"], textarea{
      width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 6px;
      box-sizing: border-box; font-size: 16px; transition: all 0.3s;
    }

    .visit-buttons, .symptoms, .menu-sections, .irradiations { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .visit-buttons button, .symptoms button, .menu-sections button, .irradiations button{
      flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #f7f7f7;
      cursor: pointer; box-sizing: border-box; text-align: center; white-space: nowrap;
    }
    .visit-buttons button.active, .symptoms button.active, .menu-sections button.active, .irradiations button.active{
      background-color: #444; color: #fff;
    }

    .date-inputs input[type="datetime-local"]{
      width: calc(100% - 22px); padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
    }

    .submit-button{
      width: 100%; padding: 15px; border: none; border-radius: 4px; background-color: #ff4c4c; color: #fff;
      font-size: 18px; cursor: pointer;
    }

    .calendar-container{ display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 20px; position: relative; width: 100%; }
    .calendar{ flex: 1; background-color: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow: hidden; width: 100%; }
    .calendar table{ width: 100%; border-collapse: collapse; table-layout: fixed; }
    .calendar th, .calendar td{
      font-size: 12.5px; text-align: center; padding: 5px; cursor: pointer; vertical-align: top; width: auto;
      box-sizing: border-box; border: 2px solid #696969;
    }
    .calendar th:first-child, .calendar td:first-child{ width: 17%; font-size: 12.5px; }
    .calendar th{ background-color: #f7f7f7; }
    .calendar td:hover{ background-color: #ddd; }
    .calendar td.selected{ background-color: #13ca5e; color: #fff; }
    .week-button-container, .month-button-container{
      display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px;
    }
    .week-button, .month-button{ padding: 10px 20px; background-color: #444; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .current-month{
      text-align: center; display: block; position: absolute; left: 50%; transform: translate(-50%, -10px);
      background-color: #13ca5e; color: #fff; padding: 3px 12px; border-radius: 8px; font-size: 1.4rem; font-weight: bold; box-shadow: 0 2px 6px rgba(47,103,167,0.2);
    }

    .loading-spinner{
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; text-align: center;
      background-color: rgba(0,0,0,0.6); padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .spinner{ width: 60px; height: 60px; border: 5px solid rgba(255,255,255,0.2); border-top-color: #00d1ff; border-radius: 50%; animation: spin 0.7s linear infinite; margin-left: 12px; }
    .loading-text{ margin-top: 20px; font-size: 15px; font-weight: bold; color: #ffffff; letter-spacing: 1px; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    @keyframes spin { to { transform: rotate(360deg); } }

    .available{ color: red; }
    .unavailable{ background-color: #d3d3d3; }

    .menu-section{ display: none; }
    .menu-section.active{ display: block; }

    #repairLabel, #repairButtons{ display: none; }

    #treatment-text{ background-color: #eef9f5; padding: 10px; border-radius: 4px; margin-top: 1px; }

    .highlight-background{
      background-color: #13ca5e; padding: 10px; border-radius: 6px; font-size: 18px; font-weight: 600; color: white;
      text-align: center; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: pointer;
    }
    .highlight-text{ font-weight: bold; display: inline-block; color: #fff; }

    .info-text{
      margin-top: 20px; margin-bottom: 10px; font-size: 13px; color: #000; line-height: 1.5; text-align: center; word-wrap: break-word;
      background-color: #eef9f5; padding: 10px; border-radius: 4px;
    }
    @media (max-width: 768px){
      .info-text{ font-size: 11.5px; margin-top: 10px; line-height: 2.0; }
    }

    .symptoms, .options{ display: block; }
    .symptoms button, .options button{
      display: block; width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #f7f7f7;
      cursor: pointer; box-sizing: border-box; text-align: center; white-space: nowrap;
    }
    .symptoms button.active, .options button.active{ background-color: #444; color: #fff; }

    .info-row{ display: flex; justify-content: space-between; align-items: center; margin: -5px 0; }
    hr{ margin: -5px 0; }

    .edit-button{
      background-color: #ff6b6b; color: #fff; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; transition: background-color 0.3s;
      white-space: nowrap; width: 80px; text-align: center;
    }
    .edit-button:hover{ background-color: #ff4f4f; }

    input:focus, textarea:focus{ border-color: #13ca5e; outline: none; box-shadow: 0 0 8px rgba(0,123,255,0.2); }
    button{ padding: 12px; border: none; border-radius: 6px; background-color: #13ca5e; color: #000000; font-size: 16px; cursor: pointer; transition: all 0.3s; }
    button:hover{ background-color: #e9e9e9; transform: scale(1.05); }
    .submit-button:hover{ background-color: #c82333; }
    @media (max-width: 768px){
      .container{ padding: 15px; }
      h1{ font-size: 22px; }
      input, button{ font-size: 14px; }
    }
    button.active{ outline: 2px solid #696969; outline-offset: 2px; }

    /* ナビゲーションバー（未使用だが残置） */
    .sidebar{ position: fixed; right: 0; top: 50%; transform: translateY(-50%); background: #1e1e2d; padding: 10px; border-radius: 10px 0 0 10px; z-index: 1000; }
    .sidebar a{ display: block; padding: 15px; color: white; text-decoration: none; text-align: center; font-size: 14px; margin-bottom: 10px; background: #4a90e2; border-radius: 5px; transition: background 0.3s; }
    .sidebar a:hover{ background: #357ac4; }
    .section{ padding: 50px 10px; margin-top: 30px; }
  </style>
</head>

<body>
  <!-- 右側の追従ナビ -->
  <div class="side-nav" id="sideNav">
    <a href="#section-message">
      <span>⇩</span>
      <i class="fas fa-comment"></i>
    </a>
  </div>

  <div class="container">
    <h1>アイプロ<br>予約フォーム</h1>

    <div class="label">お客様名<span class="required">必須</span></div>
    <input type="text" id="name" placeholder="お名前を入力してください" oninput="saveInput('name')">

    <div id="treatment-text" style="display: none; margin-bottom: 10px;"></div>

    <!-- ▼ 追加：希望撮影項目 -->
    <div class="label" id="shootingLabel">希望撮影項目<span class="required">必須</span></div>
    <div class="options" id="shootingOptions">
      <button type="button" onclick="selectShootingItem(this)" data-value="ウエディング">ウエディング</button>
      <button type="button" onclick="selectShootingItem(this)" data-value="お子様撮影">お子様撮影</button>
      <button type="button" onclick="selectShootingItem(this)" data-value="成人式">成人式</button>
      <button type="button" onclick="selectShootingItem(this)" data-value="商品や建物などの宣材撮影">商品や建物などの宣材撮影</button>
      <button type="button" onclick="selectShootingItem(this)" data-value="婚活用などのプロフィール写真">婚活用などのプロフィール写真</button>
      <button type="button" onclick="selectShootingItem(this)" data-value="その他">その他</button>
    </div>
    <div id="shooting-other-wrapper" style="display:none; margin-top:-8px; margin-bottom:12px;">
      <input type="text" id="shootingOtherText"
        placeholder="具体的にご記入ください（例：七五三／建築／ペット撮影など）"
        oninput="updateShootingOther()">
    </div>
    <!-- ▲ 追加ここまで -->

    <div class="label" id="course">メニューをお選びください<span class="required">必須</span></div>
    <div class="info-text">※18時以降での打ち合わせや来館をご希望される方は、メッセージからのお問い合わせお願いします。</div>
    <div class="info-text">※ウエディング撮影をご希望の方でドレスの試着と撮影を同時にご希望の方はメッセージからのお問い合わせお願いします</div>
    <div class="info-text">※メニューを選択すると空き状況のカレンダーが表示されます</div>
    <div class="symptoms">
      <button type="button" onclick="selectSymptom(this, 'treatment1')" data-price="15000">来店打合せ予約</button>
      <button type="button" onclick="selectSymptom(this, 'treatment2')" data-price="15000">オンライン打合せ予約</button>
    </div>

    <div class="label">希望日時<span class="required">必須</span></div>
    <div class="calendar-container">
      <div class="current-month-container">
        <span class="current-month" id="currentMonth">月</span>
      </div>

      <div class="month-button-container">
        <button class="month-button" onclick="previousmonth()">前月</button>
        <button class="month-button" onclick="nextmonth()">翌月</button>
      </div>

      <div class="week-button-container">
        <button class="week-button" onclick="previousWeek()">前週</button>
        <button class="week-button" onclick="nextWeek()">翌週</button>
      </div>

      <div id="calendar1" class="calendar">
        <table>
          <thead>
            <tr id="calendar-header">
              <th>時間</th>
              <th></th><th></th><th></th><th></th><th></th><th></th><th></th>
            </tr>
          </thead>
          <tbody><!-- カレンダー内容 --></tbody>
        </table>
      </div>

      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <div class="loading-text">読み込み中...</div>
      </div>
    </div>

    <div class="label">メッセージ<br>（質問等お気軽にご記入ください）</div>
    <textarea id="message" rows="4" placeholder="メッセージを入力してください"></textarea>

    <div class="label">ご予約内容</div>
    <div id="displayInfo"></div>

    <button class="submit-button" id="section-message" onclick="submitForm()">予約を行う</button>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script>
    let selectedSymptom = [];   // 選択中メニュー（配列）
    let selectedFullDate = '';
    let currentDate = new Date();
    let availabilityCache = {};
    let totalAmount = 0;
    let menuPrice = 0;
    let optionsPrice = 0;
    let totalMinutes = 0;
    let selectedVisitTime = 0;  // 訪問時間（必要ならボタンで設定）
    let selectedMenuTime = 0;   // メニュー所要時間（分）

    // ▼ 追加：希望撮影項目
    let selectedShootingItem = '';   // 希望撮影項目の選択値
    let shootingOtherText = '';      // 「その他」自由記載

    // メニューの基準時間
    const menuTimes = {
      '来店打合せ予約': 90,
      'オンライン打合せ予約': 90,
    };

    document.addEventListener('DOMContentLoaded', function () {
      // LIFF初期化
      liff.init({ liffId: '2007890432-Qx1VEejP' })
        .then(() => console.log('LIFF初期化成功'))
        .catch(err => console.log('LIFF初期化失敗', err));

      // 前回入力の復元
      const savedName = localStorage.getItem('name');
      const savedPhone = localStorage.getItem('phone');
      if (savedName) {
        const nEl = document.getElementById('name');
        if (nEl) nEl.value = savedName;
      }
      if (savedPhone) {
        const pEl = document.getElementById('phone'); // ※現在phone入力は未設置。あれば復元
        if (pEl) pEl.value = savedPhone;
      }

      // 初期はカレンダー非表示
      const calendarContainer = document.querySelector('.calendar-container');
      if (calendarContainer) calendarContainer.style.display = 'none';

      setupSmoothScroll();
      setupEventListeners();

      // 初回ロード
      fetchAvailability(currentDate);
    });

    /* ---------- UI基本 ---------- */
    function setupSmoothScroll() {
      document.querySelectorAll('.side-nav a').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const targetId = this.getAttribute('href').substring(1);
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            window.scrollTo({ top: targetElement.offsetTop - 20, behavior: 'smooth' });
          }
        });
      });
    }

    function setupEventListeners() {
      const nameInput = document.getElementById('name');
      if (nameInput) nameInput.addEventListener('input', updateDisplayInfo);

      // 症状（メニュー）ボタン
      document.querySelectorAll('.symptoms button').forEach(button => {
        button.addEventListener('click', () => {
          // カレンダー表示制御（選択があれば表示）
          const calendarContainer = document.querySelector('.calendar-container');
          if (document.querySelectorAll('.symptoms button.active').length > 0) {
            calendarContainer.style.display = 'block';
          } else {
            calendarContainer.style.display = 'none';
          }
          updateDisplayInfo();
        });
      });

      // 訪問時間ボタン
      document.querySelectorAll('.visit-buttons button').forEach(button => {
        button.addEventListener('click', updateDisplayInfo);
      });
    }

    function saveInput(id) {
      const el = document.getElementById(id);
      if (el) localStorage.setItem(id, el.value);
    }

    function scrollToElement(id) {
      const el = document.getElementById(id);
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    /* ---------- 希望撮影項目（追加） ---------- */
    function selectShootingItem(button) {
      // 単一選択：他のボタンのactive解除
      document.querySelectorAll('#shootingOptions button').forEach(btn => {
        if (btn !== button) btn.classList.remove('active');
      });
      // トグル（同じボタンで解除も可）
      button.classList.toggle('active');

      // 値の更新
      selectedShootingItem = button.classList.contains('active')
        ? (button.getAttribute('data-value') || button.textContent.trim())
        : '';

      // 「その他」入力の表示/非表示
      const otherWrap = document.getElementById('shooting-other-wrapper');
      if (otherWrap) {
        if (selectedShootingItem === 'その他') {
          otherWrap.style.display = 'block';
        } else {
          otherWrap.style.display = 'none';
          shootingOtherText = '';
          const otherInput = document.getElementById('shootingOtherText');
          if (otherInput) otherInput.value = '';
        }
      }

      updateDisplayInfo();
    }

    function updateShootingOther() {
      const otherInput = document.getElementById('shootingOtherText');
      shootingOtherText = otherInput ? otherInput.value : '';
      updateDisplayInfo();
    }

    /* ---------- 選択内容の表示 ---------- */
    function updateDisplayInfo() {
      const name = (document.getElementById('name')?.value) || '';

      // ▼ 希望撮影項目テキスト
      const shootingText = selectedShootingItem
        ? (selectedShootingItem === 'その他'
            ? (shootingOtherText ? `その他（${shootingOtherText}）` : 'その他（内容未記入）')
            : selectedShootingItem)
        : '未選択です';

      const selectedSymptomText = selectedSymptom.length > 0
        ? `<span style="color:#13ca5e;"><strong>【メニュー】</strong></span><br>・${selectedSymptom.join('<br>')}`
        : '・メニューが未選択です';

      totalMinutes = (selectedMenuTime || 0) + (selectedVisitTime || 0);
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;
      const totalTimeText = `<span style="color:#13ca5e;"><strong>【所要時間】</strong></span><br>・${h > 0 ? h + '時間' : ''}${m}分`;

      const selectedDateText = selectedFullDate
        ? `<span style="color:#13ca5e;"><strong>【希望日時】</strong></span><br>・${selectedFullDate}`
        : '・日時が未選択です';

      const displayInfo = document.getElementById('displayInfo');
      if (displayInfo) {
        displayInfo.innerHTML = `
          <div class="info-row">
            <p><span style="color:#13ca5e;"><strong>【お名前】</strong></span><br>・${name}</p>
            <button class="edit-button" onclick="scrollToElement('name')">修正する</button>
          </div>
          <hr>
          <div class="info-row">
            <p><span style="color:#13ca5e;"><strong>【希望撮影項目】</strong></span><br>・${shootingText}</p>
            <button class="edit-button" onclick="scrollToElement('shootingLabel')">修正する</button>
          </div>
          <hr>
          <div class="info-row">
            <p>${selectedSymptomText}</p>
            <button class="edit-button" onclick="scrollToElement('course')">修正する</button>
          </div>
          <hr>
          <div class="info-row">
            <p>${totalTimeText}</p>
          </div>
          <hr>
          <div class="info-row">
            <p>${selectedDateText}</p>
            <button class="edit-button" onclick="scrollToElement('calendar1')">修正する</button>
          </div>
          <hr>
        `;
      }
    }

    /* ---------- メニュー選択 ---------- */
    function selectSymptom(button, treatmentId) {
      // 日時リセット
      selectedFullDate = '';

      // 単一選択にする
      document.querySelectorAll('.symptoms button').forEach(btn => {
        if (btn !== button) btn.classList.remove('active');
      });

      // トグル
      button.classList.toggle('active');

      const treatmentText = document.getElementById('treatment-text');

      if (button.classList.contains('active')) {
        const selectedMenu = button.textContent.trim();
        selectedMenuTime = menuTimes[selectedMenu] ?? 90; // デフォルト90分
        selectedSymptom = [selectedMenu];
        menuPrice = parseInt(button.getAttribute('data-price'), 10) || 0;

        if (treatmentText) {
          treatmentText.innerHTML = `<div style="text-align: left;"><strong>所要時間：${selectedMenuTime}分</strong></div>`;
          treatmentText.style.display = 'block';
          button.parentNode.insertBefore(treatmentText, button.nextSibling);
        }
      } else {
        selectedMenuTime = 0;
        selectedSymptom = [];
        menuPrice = 0;
        if (treatmentText) treatmentText.style.display = 'none';
      }

      fetchAvailability(currentDate);
      updateDisplayInfo();
    }

    function updateTotalAmount() {
      totalAmount = (menuPrice || 0) + (optionsPrice || 0);
      updateDisplayInfo();
    }

    function selectVisit(element) {
      // 日時リセット
      selectedFullDate = '';
      document.querySelectorAll('.visit-buttons button').forEach(btn => btn.classList.remove('active'));
      element.classList.add('active');

      fetchAvailability(currentDate);
      updateDisplayInfo();
    }

    /* ---------- 日付選択 ---------- */
    function selectDate(cell) {
      if (cell.classList.contains('unavailable')) return;

      // 既存選択を解除
      document.querySelectorAll('.calendar td.selected').forEach(td => td.classList.remove('selected'));
      cell.classList.add('selected');

      const selectedDayISO = cell.getAttribute('data-date');
      const timeCell = cell.parentElement?.cells[0];
      const selectedTime = timeCell ? timeCell.textContent : '';

      if (selectedDayISO && selectedTime) {
        const date = new Date(selectedDayISO);
        selectedFullDate =
          `${date.getFullYear()}年${String(date.getMonth() + 1).padStart(2, '0')}月${String(date.getDate()).padStart(2, '0')}日 ${selectedTime}`;
      }
      updateDisplayInfo();
    }

    /* ---------- 予約データ取得 ---------- */
    async function fetchAvailability(date) {
      const startTime = new Date(date);
      const endTime = new Date(date);
      endTime.setDate(endTime.getDate() + 7);

      const cacheKey = startTime.toISOString() + endTime.toISOString();

      if (availabilityCache[cacheKey]) {
        const cached = availabilityCache[cacheKey];
        updateCalendar(cached.availability, cached.businessDays);
        return;
      }

      // ▼ Apps Script エンドポイント
      const url =
        'https://script.google.com/macros/s/AKfycbzD_GoRogOMPBTfOMClrMDV3UGzMw7A--elktUg9U7RaeCY8bQAJispCLw2ZIeDoFAMRQ/exec' +
        `?startTime=${startTime.toISOString()}&endTime=${endTime.toISOString()}`;

      try {
        showLoadingSpinner();
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // 営業日イベント抽出（title or summary どちらでも対応）
        const businessDays = data
          .filter(ev => (ev.summary === '営業日' || ev.title === '営業日'))
          .map(ev => ({ start: new Date(ev.startTime), end: new Date(ev.endTime) }));

        availabilityCache[cacheKey] = { availability: data, businessDays };
        updateCalendar(data, businessDays);
      } catch (e) {
        console.error('Error fetching availability:', e);
        // 失敗時も空で更新（全✕フォールバック）
        updateCalendar([], []);
      } finally {
        hideLoadingSpinner();
      }
    }

    /* ---------- カレンダー描画 ---------- */
    function updateCalendar(availability, businessDays) {
      const calendar = document.getElementById('calendar1');
      if (!calendar) return;

      const table = calendar.querySelector('table tbody');
      if (!table) return;

      // 表示する時間帯
      const times = [
        '10:00', '10:30', '11:00', '11:30',
        '12:00', '12:30', '13:00', '13:30',
        '14:00', '14:30', '15:00', '15:30',
        '16:00', '16:30', '17:00', '17:30',
        '18:00'
      ];

      // 初回：行生成
      if (table.rows.length === 0) {
        for (const t of times) {
          const row = document.createElement('tr');
          const timeCell = document.createElement('td');
          timeCell.textContent = t;
          timeCell.style.fontWeight = 'bold';
          row.appendChild(timeCell);

          for (let i = 0; i < 7; i++) {
            const cell = document.createElement('td');
            cell.style.cursor = 'pointer';
            cell.style.textAlign = 'center';
            cell.addEventListener('click', () => selectDate(cell));
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
      }

      // ヘッダー更新
      updateCalendarHeader(currentDate);

      // セル初期化
      for (let r of table.rows) {
        for (let i = 1; i < r.cells.length; i++) {
          const cell = r.cells[i];
          cell.textContent = '';
          cell.removeAttribute('data-date');
          cell.classList.remove('available', 'unavailable', 'selected');
          cell.style.color = '';
          cell.style.backgroundColor = '';
        }
      }

      const now = new Date();

      // 営業日ウィンドウが存在するか（存在しない場合にフォールバック動作を有効化）
      const hasBusinessWindows = businessDays && businessDays.length > 0;

      for (let i = 0; i < 7; i++) {
        const day = new Date(currentDate);
        day.setDate(day.getDate() + i);

        // その日の営業ウィンドウ
        const windowsOfDay = (businessDays || []).filter(w => {
          const s = new Date(w.start);
          const e = new Date(w.end);
          return s.toDateString() === day.toDateString() || e.toDateString() === day.toDateString();
        });

        for (let j = 0; j < times.length; j++) {
          const cell = table.rows[j].cells[i + 1];

          const slotStart = new Date(day);
          const [hh, mm] = times[j].split(':').map(Number);
          slotStart.setHours(hh, mm, 0, 0);

          // 所要時間（メニュー + 訪問）
          const duration = (selectedMenuTime || 90) + (selectedVisitTime || 0);
          const slotEnd = new Date(slotStart);
          slotEnd.setMinutes(slotEnd.getMinutes() + duration);

          // data-date
          cell.setAttribute('data-date', slotStart.toISOString());

          // 1) 過去は✕
          if (slotStart < now) { markX(cell); continue; }

          // 2) 日跨ぎは✕
          if (slotEnd.getDate() !== slotStart.getDate()) { markX(cell); continue; }

          // 3) 営業ウィンドウ内か？
          let withinBusiness = false;

          if (hasBusinessWindows) {
            withinBusiness = windowsOfDay.some(w => {
              const s = new Date(w.start);
              const e = new Date(w.end);
              return slotStart >= s && slotEnd <= e;
            });
          } else {
            // 営業日イベントが無い場合のフォールバック
            // 例：水曜休にしたければ getDay() === 3 を休に
            withinBusiness = slotStart.getDay() !== 3;
          }

          if (!withinBusiness) { markX(cell); continue; }

          // 4) 予約重複をチェック（営業日イベントは除外）
          const hasBooking = availability.some(ev => {
            if (ev.summary === '営業日' || ev.title === '営業日') return false;
            const es = new Date(ev.startTime);
            const ee = new Date(ev.endTime);
            return es < slotEnd && slotStart < ee; // 重なれば予約あり
          });

          if (hasBooking) {
            markX(cell);
          } else {
            markO(cell);
          }
        }
      }
    }

    function markX(cell) {
      cell.textContent = '✕';
      cell.classList.add('unavailable');
      cell.style.color = 'red';
    }
    function markO(cell) {
      cell.textContent = '◯';
      cell.classList.add('available');
      cell.style.color = 'green';
    }

    /* ---------- ヘッダー（日付・祝日色付け） ---------- */
    function updateCalendarHeader(date) {
      const headerRow = document.getElementById('calendar-header');
      if (!headerRow) return;

      const headers = headerRow.querySelectorAll('th:not(:first-child)');

      // 祝日（必要に応じて更新）
      const holidays = [
        '2025-02-11', '2025-02-23', '2025-02-24', '2025-03-20', '2025-04-29',
        '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-06', '2025-07-21',
        '2025-08-11', '2025-09-15', '2025-09-23', '2025-10-13', '2025-11-03',
        '2025-11-23', '2025-11-24'
      ];

      const startDate = new Date(date);

      headers.forEach((th, idx) => {
        const d = new Date(startDate);
        d.setDate(d.getDate() + idx);

        const dow = ['日', '月', '火', '水', '木', '金', '土'];
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const formatted = `${yyyy}-${mm}-${dd}`;
        const label = `${d.getDate()}(${dow[d.getDay()]})`;

        th.innerHTML = label.replace('(', '<br>(');

        if (holidays.includes(formatted) || d.getDay() === 0) {
          th.style.color = 'red';
        } else if (d.getDay() === 6) {
          th.style.color = 'blue';
        } else {
          th.style.color = '';
        }
      });

      const currentMonthElement = document.getElementById('currentMonth');
      if (currentMonthElement) {
        currentMonthElement.innerHTML =
          `<span class="year">${startDate.getFullYear()}年</span><br><span class="month">${startDate.getMonth() + 1}月</span>`;
      }
    }

    /* ---------- 週/月ナビ ---------- */
    function nextWeek() { currentDate.setDate(currentDate.getDate() + 7); fetchAvailability(currentDate); }
    function previousWeek() { currentDate.setDate(currentDate.getDate() - 7); fetchAvailability(currentDate); }
    function nextmonth() { currentDate.setMonth(currentDate.getMonth() + 1); currentDate.setDate(1); fetchAvailability(currentDate); }
    function previousmonth() { currentDate.setMonth(currentDate.getMonth() - 1); currentDate.setDate(1); fetchAvailability(currentDate); }

    /* ---------- スピナー ---------- */
    function showLoadingSpinner() { const sp = document.getElementById('loadingSpinner'); if (sp) sp.style.display = 'block'; }
    function hideLoadingSpinner() { const sp = document.getElementById('loadingSpinner'); if (sp) sp.style.display = 'none'; }

    /* ---------- 送信 ---------- */
    function submitForm() {
      const nameInput = document.getElementById('name');
      const phoneInput = document.getElementById('phone'); // ※現在未設置
      const messageInput = document.getElementById('message');

      const formData = {
        name: nameInput ? nameInput.value.trim() : '',
        phone: phoneInput ? phoneInput.value.trim() : '',
        shootingItem:
          selectedShootingItem
            ? (selectedShootingItem === 'その他'
                ? (shootingOtherText ? `その他：${shootingOtherText.trim()}` : 'その他：')
                : selectedShootingItem)
            : null,
        selectedSymptom: selectedSymptom?.length > 0 ? selectedSymptom : null,
        dates: selectedFullDate ? [selectedFullDate] : null,
        message: messageInput ? messageInput.value.trim() : ''
      };

      if (!formData.name) return alert('お名前を入力してください。');
      if (!formData.shootingItem) return alert('希望撮影項目を選択してください。');
      if (selectedShootingItem === 'その他' && !shootingOtherText.trim()) {
        return alert('「その他」を選択した場合、内容をご記入ください。');
      }
      if (!formData.selectedSymptom) return alert('メニューを選択してください。');
      if (!formData.dates) return alert('希望日時を選択してください。');

      liff.sendMessages([{
        type: 'text',
        text:
          `【予約フォーム】\n` +
          `お名前：${formData.name}\n` +
          `撮影項目：${formData.shootingItem}\n` +
          `希望日時：\n ${formData.dates[0]}\n` +
          `メニュー：${formData.selectedSymptom}\n` +
          `メッセージ：${formData.message}`
      }]).then(() => {
        alert('キャンセルの場合はLINEのチャット又は電話にてお知らせください。');
        liff.closeWindow();
      }).catch(err => {
        console.error('メッセージの送信に失敗しました', err);
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return `${d.getFullYear()}年${String(d.getMonth() + 1).padStart(2, '0')}月${String(d.getDate()).padStart(2, '0')}日 ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    }
  </script>
</body>
</html>
